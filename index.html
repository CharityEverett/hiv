<!DOCTYPE html>
<html>
  <head>
    <title>Harvard WebXR HIV Data Visualization</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handy-work/build/handy-controls.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      body { margin: 0; overflow: hidden; }
      #mode-select {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: rgba(0,0,0,0.8);
        padding: 20px;
        border-radius: 10px;
        text-align: center;
      }
      .mode-button {
        padding: 10px 20px;
        margin: 10px;
        font-size: 18px;
        cursor: pointer;
      }
      #toggle-mode {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        padding: 10px 20px;
        background: rgba(0,0,0,0.8);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
    <script>
      // Previous virus-core component code remains the same

      AFRAME.registerComponent('wrist-tracking', {
        init: function() {
          if (!navigator.xr) {
            console.warn('WebXR not available');
            return;
          }

          this.el.sceneEl.addEventListener('enter-vr', () => {
            if (this.el.sceneEl.is('ar-mode')) {
              navigator.xr.requestSession('immersive-ar', {
                optionalFeatures: ['hand-tracking']
              }).then(session => {
                session.addEventListener('select', this.onSelect.bind(this));
              });
            }
          });
        },

        onSelect: function(event) {
          // Update virus model position to wrist location
          const frame = event.frame;
          const pose = frame.getPose(event.inputSource.targetRaySpace, this.el.sceneEl.renderer.xr.getReferenceSpace());
          if (pose) {
            this.el.setAttribute('position', pose.transform.position);
          }
        }
      });

      window.onload = function() {
        const modeSelect = document.getElementById('mode-select');
        const scene = document.querySelector('a-scene');

        document.getElementById('ar-button').onclick = function() {
          modeSelect.style.display = 'none';
          scene.enterAR();
        };

        document.getElementById('vr-button').onclick = function() {
          modeSelect.style.display = 'none';
          scene.enterVR();
        };
      };
    </script>
  </head>
  <body>
    <div id="mode-select">
      <button id="ar-button" class="mode-button">View in AR</button>
      <button id="vr-button" class="mode-button">View in VR</button>
    </div>
    <button id="toggle-mode">Toggle AR/VR</button>

    <a-scene embedded arjs='sourceType: webcam; debugUIEnabled: false;' renderer="antialias: true">
      <a-entity light="type: ambient; intensity: 0.5"></a-entity>
      <a-entity light="type: directional; intensity: 0.8; position: -1 1 1"></a-entity>

      <a-entity
        id="virus-model"
        position="0 0.5 0"
        scale="1 1 1"
        virus-core
        wrist-tracking
        clickable
        animation="property: rotation; to: 0 360 0; loop: true; dur: 30000; easing: linear">
      </a-entity>

      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
