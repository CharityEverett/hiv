<!DOCTYPE html>
<html>
  <head>
    <title>Harvard WebXR HIV Data Visualization</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/handy-work/build/handy-controls.min.js"></script>
    <script>
    AFRAME.registerComponent('virus-core', {
  init: function() {
    // Create the gray core sphere
    const core = document.createElement('a-sphere');
    core.setAttribute('radius', '2');
    core.setAttribute('color', '##bbbbbb');
    core.setAttribute('roughness', '1');
    core.setAttribute('metalness', '0.2');
    this.el.appendChild(core);

    // Generate spikes using fibonacci sphere distribution
    const numSpikes = 120;
    const phi = Math.PI * (3 - Math.sqrt(5));

    for (let i = 0; i < numSpikes; i++) {
      const y = 1 - (i / (numSpikes - 1)) * 2;
      const radius = Math.sqrt(1 - y * y);
      const theta = phi * i;

      const x = Math.cos(theta) * radius;
      const z = Math.sin(theta) * radius;

      const spike = document.createElement('a-entity');
      spike.setAttribute('geometry', {
        primitive: 'cone',
        height: '0.5',
        radiusTop: '0.15',    // Switched: wider at the top
        radiusBottom: '0.02'  // Switched: narrower at the base
      });
      spike.setAttribute('material', {
        color: '#FF4444',
        roughness: 0.7,
        metalness: 0.2
      });
      
      // Position spike with base touching sphere surface
      spike.setAttribute('position', `${x * 2} ${y * 2} ${z * 2}`);
      
      // Calculate rotation to point outward from sphere center
      const direction = new THREE.Vector3(x, y, z).normalize();
      const quaternion = new THREE.Quaternion();
      const up = new THREE.Vector3(0, 1, 0);
      quaternion.setFromUnitVectors(up, direction);
      const euler = new THREE.Euler().setFromQuaternion(quaternion);
      
      // Convert rotation to degrees and set
      spike.setAttribute('rotation', {
        x: THREE.MathUtils.radToDeg(euler.x),
        y: THREE.MathUtils.radToDeg(euler.y),
        z: THREE.MathUtils.radToDeg(euler.z)
      });
      
      this.el.appendChild(spike);
    }
  }
});
    </script>
  </head>
  <body>
    <a-scene>
      <!-- Environment -->
      <a-sky color="#8fd3fe"></a-sky>
      <a-entity light="type: ambient; intensity: 0.5"></a-entity>
      <a-entity light="type: directional; intensity: 0.8; position: -1 1 1"></a-entity>

      <!-- Main virus structure -->
      <a-entity
        id="virus-model"
        position="0 1.6 -4"
        rotation="0 0 0"
        virus-core
        animation="property: rotation; to: 0 360 0; loop: true; dur: 30000; easing: linear">
      </a-entity>

      <!-- Hand tracking setup -->
      <a-entity handy-controls="right:#right-gltf;materialOverride:right;" material="color:gold;metalness:1;roughness:0;">
        <!-- Ray and Grip controls -->
        <a-entity data-right="ray" raycaster="objects: .clickable; far: 10;">
          <a-entity position="0 0 -0.22" class="pose-label" text="value: Interact to learn more; align: center;"></a-entity>
        </a-entity>
        <a-entity data-left="ray" raycaster="objects: .clickable; far: 10;">
          <a-entity position="0 0 -0.22" class="pose-label" text="value: Interact to learn more; align: center;"></a-entity>
        </a-entity>

        <!-- Magnetic interaction points -->
        <a-entity id="right-magnet" data-right="grip" data-magnet=".magnet-right:not([data-no-magnet]),.magnet:not([data-no-magnet])" 
                  grab-magnet-target="startEvents:squeezestart,pose_fist;stopEvents:pose_flat_fuseShort,squeezeend;"></a-entity>
        <a-entity id="left-magnet" data-left="grip" data-magnet=".magnet-left:not([data-no-magnet]),.magnet:not([data-no-magnet])" 
                  grab-magnet-target="startEvents:squeezestart,pose_fist;stopEvents:pose_flat_fuseShort,squeezeend;"></a-entity>

        <!-- Hand position markers -->
        <a-sphere id="right-no-magnet" data-right="grip" data-no-magnet radius="0.01" color="red"></a-sphere>
        <a-sphere id="left-no-magnet" data-left="grip" data-no-magnet radius="0.01" color="red"></a-sphere>
      </a-entity>

      <!-- Camera rig -->
      <a-entity position="0 1.6 0">
        <a-camera></a-camera>
      </a-entity>
    </a-scene>
  </body>
</html>
