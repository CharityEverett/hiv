<!DOCTYPE html>
<html>
<head>
    <title>Harvard HIV Research WebXR Data Visualization</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
    </style>
    <script>
        AFRAME.registerComponent('virus-core', {
            init: function() {
                const core = document.createElement('a-sphere');
                core.setAttribute('radius', '0.5');
                core.setAttribute('material', {
                    color: '#4B0082',
                    roughness: 0.1,
                    metalness: 0.2,
                    opacity: 0.6,
                    transparent: true,
                    shader: 'standard',
                    emissive: '#2A1B3D',
                    emissiveIntensity: 0.7,
                    normalScale: new THREE.Vector2(1, 1),
                    displacementScale: 0.2,
                    displacementBias: 0.1,
                    sphericalEnvMap: true
                });

                core.setAttribute('geometry', {
                    primitive: 'sphere',
                    radius: 0.5,
                    segmentsWidth: 64,
                    segmentsHeight: 64
                });
                this.el.appendChild(core);

                const numSpikes = 60;
                const phi = Math.PI * (3 - Math.sqrt(5));

                for (let i = 0; i < numSpikes; i++) {
                    const y = 1 - (i / (numSpikes - 1)) * 2;
                    const radius = Math.sqrt(1 - y * y);
                    const theta = phi * i;
                    const x = Math.cos(theta) * radius;
                    const z = Math.sin(theta) * radius;

                    const spikeContainer = document.createElement('a-entity');
                    
                    const stem = document.createElement('a-cone');
                    stem.setAttribute('height', '0.6');
                    stem.setAttribute('radius-bottom', '0.035');
                    stem.setAttribute('radius-top', '0.005');
                    stem.setAttribute('color', '#4169E1');
                    stem.setAttribute('opacity', '0.9');

                    const bulb = document.createElement('a-sphere');
                    bulb.setAttribute('radius', '0.04');
                    bulb.setAttribute('color', '#00FFFF');
                    bulb.setAttribute('emission', '#00FFFF');
                    bulb.setAttribute('position', '0 0.3 0');

                    spikeContainer.appendChild(stem);
                    spikeContainer.appendChild(bulb);
                    spikeContainer.setAttribute('position', `${x * 0.5} ${y * 0.5} ${z * 0.5}`);

                    const direction = new THREE.Vector3(x, y, z).normalize();
                    const quaternion = new THREE.Quaternion();
                    const up = new THREE.Vector3(0, 1, 0);
                    quaternion.setFromUnitVectors(up, direction);
                    const euler = new THREE.Euler().setFromQuaternion(quaternion);
                    
                    spikeContainer.setAttribute('rotation', {
                        x: THREE.MathUtils.radToDeg(euler.x),
                        y: THREE.MathUtils.radToDeg(euler.y),
                        z: THREE.MathUtils.radToDeg(euler.z)
                    });
                    
                    this.el.appendChild(spikeContainer);
                }
            }
        });

        AFRAME.registerComponent('research-timeline', {
            init: function() {
                const timelineData = [
                    { institution: "Stephen Harrison's Lab- Laboratory of Structural Biology", color: "#00FFFF" },
                    { institution: "Dana Farber Cancer Center", color: "#4169E1" },
                    { institution: "Boston Children's Hospital", color: "#9370DB" },
                    { institution: "Brigham and Women's Hospital", color: "#7B68EE" },
                    { institution: "Ragon Institute of Mass General, MIT, and Harvard", color: "#4B0082" },
                    { institution: "Beth Israel Deaconess Medical Center", color: "#40E0D0" },
                    { institution: "Mass General", color: "#8A7BB8" }
                ];

                const modelMap = {
                    "Stephen Harrison's Lab- Laboratory of Structural Biology": "stephen-harrisons-lab",
                    "Dana Farber Cancer Center": "dana-farber-cancer-center",
                    "Boston Children's Hospital": "boston-childrens-hospital",
                    "Brigham and Women's Hospital": "brigham-and-womens-hospital",
                    "Ragon Institute of Mass General, MIT, and Harvard": "ragon-institute",
                    "Beth Israel Deaconess Medical Center": "beth-israel-deaconess",
                    "Mass General": "mass-general"
                };

                const radius = 3;
                const segmentCount = timelineData.length;
                const segmentAngle = 360 / segmentCount;

                timelineData.forEach((data, index) => {
                    const segmentContainer = document.createElement('a-entity');
                    segmentContainer.setAttribute('rotation', `0 ${index * segmentAngle} 0`);
                    
                    const arc = document.createElement('a-torus');
                    arc.setAttribute('radius', radius);
                    arc.setAttribute('radius-tubular', '0.15');
                    arc.setAttribute('arc', segmentAngle);
                    arc.setAttribute('color', data.color);
                    arc.setAttribute('rotation', '90 0 0');

                    const building = document.createElement('a-entity');
                    building.setAttribute('gltf-model', `#${modelMap[data.institution]}`);
                    building.setAttribute('position', `${radius} 0.5 0`);
                    building.setAttribute('rotation', '0 90 0');
                    building.setAttribute('scale', '2 1.5 0');
                    building.setAttribute('material', {
                        color: data.color,
                        metalness: 0.3,
                        roughness: 0.7,
                        emissive: data.color,
                        emissiveIntensity: 0.2
                    });

                    segmentContainer.appendChild(arc);
                    segmentContainer.appendChild(building);
                    this.el.appendChild(segmentContainer);
                });
            }
        });

        AFRAME.registerComponent('clickable', {
            init: function() {
                this.el.addEventListener('click', function() {
                    this.setAttribute('scale', {x: 1.2, y: 1.2, z: 1.2});
                    setTimeout(() => {
                        this.setAttribute('scale', {x: 1, y: 1, z: 1});
                    }, 300);
                });
            }
        });
    </script>
</head>
<body>
    <a-scene bloom="radius: 0.66; intensity: 1.0; threshold: 0.7">
        <a-assets>
            <a-asset-item id="boston-childrens-hospital" src="assets/Institutions/BostonChildrensHospital.glb"></a-asset-item>
            <a-asset-item id="beth-israel-deaconess" src="assets/Institutions/beth_israel.glb"></a-asset-item>
            <a-asset-item id="brigham-and-womens-hospital" src="assets/Institutions/brigham_womens.glb"></a-asset-item>
            <a-asset-item id="dana-farber-cancer-center" src="assets/Institutions/dana_farber.glb"></a-asset-item>
            <a-asset-item id="mass-general" src="assets/Institutions/mass_general.glb"></a-asset-item>
            <a-asset-item id="ragon-institute" src="assets/Institutions/ragon_institute.glb"></a-asset-item>
            <a-asset-item id="stephen-harrisons-lab" src="assets/Institutions/stephen_harrisons.glb"></a-asset-item>
        </a-assets>

        <a-sky color="#000033"></a-sky>
        
        <a-entity particle-system="preset: dust; particleCount: 2000; color: #4B0082, #00FFFF; size: 0.2; opacity: 0.3; blending: additive">
        </a-entity>

        <a-entity light="type: ambient; intensity: 0.5"></a-entity>
        <a-entity light="type: directional; intensity: 0.8; position: -1 1 1"></a-entity>

        <a-entity id="visualization-container" position="0 4.835 -2" rotation="-80 0 0">
            <a-entity id="virus-model" position="0 2 -3" scale="3 3 3" virus-core clickable 
                animation="property: rotation; to: 0 360 0; loop: true; dur: 30000; easing: linear">
            </a-entity>

            <a-entity id="timeline" position="0 2 -3" scale="1 3 1" research-timeline
                animation="property: rotation; to: 0 360 0; loop: true; dur: 30000; easing: linear">
            </a-entity>
        </a-entity>

        <a-entity position="0 0 0">
            <a-camera look-controls wasd-controls></a-camera>
        </a-entity>
    </a-scene>
</body>
</html>
