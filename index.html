<!DOCTYPE html>
<html>
<head>
    <title>Harvard HIV Research WebXR Data Visualization</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; }
    </style>
    <script>
        AFRAME.registerComponent('virus-core', {
            init: function() {
                const core = document.createElement('a-sphere');
                core.setAttribute('radius', '0.5');
                core.setAttribute('material', {
                    color: '#4B0082',
                    roughness: 0.1,
                    metalness: 0.2,
                    opacity: 0.6,
                    transparent: true,
                    shader: 'standard',
                    emissive: '#2A1B3D',
                    emissiveIntensity: 0.7,
                    normalScale: new THREE.Vector2(1, 1),
                    displacementScale: 0.2,
                    displacementBias: 0.1,
                    sphericalEnvMap: true
                });

                core.setAttribute('geometry', {
                    primitive: 'sphere',
                    radius: 0.5,
                    segmentsWidth: 64,
                    segmentsHeight: 64
                });
                this.el.appendChild(core);

                const numSpikes = 60;
                const phi = Math.PI * (3 - Math.sqrt(5));

                for (let i = 0; i < numSpikes; i++) {
                    const y = 1 - (i / (numSpikes - 1)) * 2;
                    const radius = Math.sqrt(1 - y * y);
                    const theta = phi * i;
                    const x = Math.cos(theta) * radius;
                    const z = Math.sin(theta) * radius;

                    const spikeContainer = document.createElement('a-entity');
                    
                    const stem = document.createElement('a-cone');
                    stem.setAttribute('height', '0.6');
                    stem.setAttribute('radius-bottom', '0.035');
                    stem.setAttribute('radius-top', '0.005');
                    stem.setAttribute('color', '#4169E1');
                    stem.setAttribute('opacity', '0.9');

                    const bulb = document.createElement('a-sphere');
                    bulb.setAttribute('radius', '0.04');
                    bulb.setAttribute('color', '#00FFFF');
                    bulb.setAttribute('emission', '#00FFFF');
                    bulb.setAttribute('position', '0 0.3 0');

                    spikeContainer.appendChild(stem);
                    spikeContainer.appendChild(bulb);
                    spikeContainer.setAttribute('position', `${x * 0.5} ${y * 0.5} ${z * 0.5}`);

                    const direction = new THREE.Vector3(x, y, z).normalize();
                    const quaternion = new THREE.Quaternion();
                    const up = new THREE.Vector3(0, 1, 0);
                    quaternion.setFromUnitVectors(up, direction);
                    const euler = new THREE.Euler().setFromQuaternion(quaternion);
                    
                    spikeContainer.setAttribute('rotation', {
                        x: THREE.MathUtils.radToDeg(euler.x),
                        y: THREE.MathUtils.radToDeg(euler.y),
                        z: THREE.MathUtils.radToDeg(euler.z)
                    });
                    
                    this.el.appendChild(spikeContainer);
                }
            }
        });

        AFRAME.registerComponent('clickable', {
            init: function() {
                this.el.addEventListener('click', function() {
                    this.setAttribute('scale', {x: 1.2, y: 1.2, z: 1.2});
                    setTimeout(() => {
                        this.setAttribute('scale', {x: 1, y: 1, z: 1});
                    }, 300);
                });
            }
        });
    </script>
</head>
<body>
    <a-scene bloom="radius: 0.66; intensity: 1.0; threshold: 0.7">
        <a-assets>
            <a-asset-item id="boston-childrens-hospital" src="assets/Institutions/BostonChildrensHospital.glb"></a-asset-item>
            <a-asset-item id="beth-israel-deaconess" src="assets/Institutions/beth_israel.glb"></a-asset-item>
            <a-asset-item id="brigham-and-womens-hospital" src="assets/Institutions/brigham_womens.glb"></a-asset-item>
            <a-asset-item id="dana-farber-cancer-center" src="assets/Institutions/dana_farber.glb"></a-asset-item>
            <a-asset-item id="mass-general" src="assets/Institutions/mass_general.glb"></a-asset-item>
            <a-asset-item id="ragon-institute" src="assets/Institutions/ragon_institute.glb"></a-asset-item>
            <a-asset-item id="stephen-harrisons-lab" src="assets/Institutions/stephen_harrisons.glb"></a-asset-item>
        </a-assets>

        <a-sky color="#000033"></a-sky>
        
        <a-entity particle-system="preset: dust; particleCount: 2000; color: #4B0082, #00FFFF; size: 0.2; opacity: 0.3; blending: additive">
        </a-entity>

        <a-entity light="type: ambient; intensity: 0.5"></a-entity>
        <a-entity light="type: directional; intensity: 0.8; position: -1 1 1"></a-entity>

        <a-entity id="visualization-container" position="0 4.835 -2" rotation="-80 0 0">
            <a-entity id="virus-model" position="0 2 -3" scale="3 3 3" virus-core clickable 
                animation="property: rotation; to: 0 360 0; loop: true; dur: 30000; easing: linear">
            </a-entity>

            <a-entity id="timeline" position="0 2 -3" scale="1 3 1" animation="property: rotation; to: 0 360 0; loop: true; dur: 30000; easing: linear">
                <a-entity gltf-model="#stephen-harrisons-lab" position="3 2.5 0" rotation="0 90 0" scale="2 1.5 0" material="color: #00FFFF"></a-entity>
                <a-entity gltf-model="#dana-farber-cancer-center" position="2.12 2.5 2.12" rotation="0 45 0" scale="2 1.5 0" material="color: #4169E1"></a-entity>
                <a-entity gltf-model="#boston-childrens-hospital" position="0 2.5 3" rotation="0 0 0" scale="2 1.5 0" material="color: #9370DB"></a-entity>
                <a-entity gltf-model="#brigham-and-womens-hospital" position="-2.12 2.5 2.12" rotation="0 -45 0" scale="2 1.5 0" material="color: #7B68EE"></a-entity>
                <a-entity gltf-model="#ragon-institute" position="-3 2.5 0" rotation="0 -90 0" scale="2 1.5 0" material="color: #4B0082"></a-entity>
                <a-entity gltf-model="#beth-israel-deaconess" position="-2.12 2.5 -2.12" rotation="0 -135 0" scale="2 1.5 0" material="color: #40E0D0"></a-entity>
                <a-entity gltf-model="#mass-general" position="0 2.5 -3" rotation="0 180 0" scale="2 1.5 0" material="color: #8A7BB8"></a-entity>
            </a-entity>
        </a-entity>

        <a-entity position="0 0 0">
            <a-camera look-controls wasd-controls></a-camera>
        </a-entity>
    </a-scene>
</body>
</html>
